<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Juan C. Rodriguez">
<meta name="dcterms.date" content="2024-12-26">
<meta name="keywords" content="Cloud SQL, Google Cloud Platform, R, Databases">
<meta name="description" content="Step-by-step guide to enable and configure a Cloud SQL database in GCP.">

<title>Enable Cloud SQL Database – R to Production</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-X94N1YEBMV"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-X94N1YEBMV', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="RtoProd.com - Your R Deployment Experts">
<meta property="og:description" content="Expert tutorials on deploying R projects to production servers, with a focus on scalability, security, and best practices.">
<meta property="og:image" content="https://RtoProd.com/posts/enable-cloud-sql-database/16_create_database.png">
<meta property="og:site_name" content="R to Production">
<meta property="og:image:height" content="232">
<meta property="og:image:width" content="474">
<meta name="twitter:title" content="RtoProd.com - Your R Deployment Experts">
<meta name="twitter:description" content="Expert tutorials on deploying R projects to production servers, with a focus on scalability, security, and best practices.">
<meta name="twitter:image" content="https://RtoProd.com/posts/enable-cloud-sql-database/16_create_database.png">
<meta name="twitter:creator" content="@RtoProdCom">
<meta name="twitter:site" content="@RtoProdCom">
<meta name="twitter:image-height" content="232">
<meta name="twitter:image-width" content="474">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">R to Production</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/RtoProd/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/RtoProdCom/"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Enable Cloud SQL Database</h1>
                  <div>
        <div class="description">
          Step-by-step guide to enable and configure a Cloud SQL database in GCP.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">GCP</div>
                <div class="quarto-category">Free-Trial</div>
                <div class="quarto-category">Database</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Juan C. Rodriguez </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 26, 2024</p>
      </div>
    </div>
    
      
    </div>
    

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>Cloud SQL, Google Cloud Platform, R, Databases</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="enable-cloud-sql-database" class="level2">
<h2 class="anchored" data-anchor-id="enable-cloud-sql-database">Enable Cloud SQL Database</h2>
<p>This guide outlines the steps to enable and configure a Cloud SQL instance in Google Cloud Platform (GCP). We will create a PostgreSQL database, configure access, and connect using R.</p>
<p>Note: The database we are creating will not be publicly accessible for security reasons. It can only be accessed through the Google Cloud environment or via secure connections like the Cloud SQL Proxy.</p>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<p>Before starting, ensure you have:</p>
<ul>
<li><a href="https://rtoprod.com/posts/create-your-gcp-account/" class="external" target="_blank">An active GCP account</a>.</li>
<li><a href="https://cloud.google.com/sdk/docs/install" class="external" target="_blank">The <code>gcloud</code> command-line interface installed and configured</a>.</li>
</ul>
</section>
<section id="important-note-on-cloud-sql-free-usage" class="level3">
<h3 class="anchored" data-anchor-id="important-note-on-cloud-sql-free-usage">Important Note on Cloud SQL Free Usage</h3>
<p>Cloud SQL is not included in the GCP Free-Tier but is available during the Free-Trial period, which provides $300 in credits to explore GCP services. This means you can create and use a Cloud SQL instance during the trial without incurring charges, as long as your usage stays within the credit limit. After the trial period or if credits are exhausted, you will be billed for any usage. Cost estimates are shown during the setup process, providing insight into potential charges based on your selected configuration.</p>
<p>Let’s get started!</p>
<hr>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Visual</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Command Line</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<ol type="1">
<li>Log in to the <a href="https://console.cloud.google.com/" class="external" target="_blank">Google Cloud console</a> and open the <strong>Navigation menu</strong> (three horizontal lines icon).</li>
</ol>
<p><img src="01_gcp.png" class="img-fluid" style="border: 1px solid black;" alt="Click the 'Navigation menu' icon." width="350"></p>
<ol start="2" type="1">
<li>Select <strong>“SQL”</strong>.</li>
</ol>
<p><img src="02_click_sql.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'SQL'." width="300"></p>
<ol start="3" type="1">
<li>Click <strong>“CREATE INSTANCE WITH YOUR FREE CREDITS”</strong>.</li>
</ol>
<p><img src="03_create_sql_instance.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'CREATE INSTANCE WITH YOUR FREE CREDITS'." width="450"></p>
<ol start="4" type="1">
<li>Click <strong>“Choose PostgreSQL”</strong>, unless you prefer another database engine.</li>
</ol>
<p><img src="04_choose_db.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'Choose PostgreSQL'." width="450"></p>
<ol start="5" type="1">
<li>Click <strong>“ENABLE API”</strong>.</li>
</ol>
<p><img src="05_enable_api.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'ENABLE API'." width="200"></p>
<ol start="6" type="1">
<li>Choose your desired SQL edition. As we are working on a simple project, we select <strong>“Enterprise”</strong> in this example.</li>
</ol>
<p><img src="06_select_plan.png" class="img-fluid" style="border: 1px solid black;" alt="Select the 'Enterprise' edition." width="450"></p>
<ol start="7" type="1">
<li>Choose your desired SQL Virtual Machine (VM). For this example we are going to select the smallest edition preset, the Sandbox VM (2 vCPU, 8 GB RAM, 10 GB Storage, and single zone). These settings can be changed later.</li>
</ol>
<p><img src="07_select_vm.png" class="img-fluid" style="border: 1px solid black;" alt="Select the 'Sandbox' edition preset." width="450"></p>
<ol start="8" type="1">
<li>Specify the <strong>“Database version”</strong> (PostgreSQL 16 in this example), fill in an <strong>“Instance ID”</strong>, and set an admin <strong>“Password”</strong> for the “postgres” user.</li>
</ol>
<p><img src="08_set_instance.png" class="img-fluid" style="border: 1px solid black;" alt="Fill in the 'Instance info'." width="450"></p>
<ol start="9" type="1">
<li>Select the instance <strong>“Region”</strong> and <strong>“Zonal availability”</strong>. For this example, “us-central1” (as is the same as we used in the previous posts), and “Single zone” as this app is a small project (not widely used yet, we can change this in the future).</li>
</ol>
<p><img src="09_choose_region.png" class="img-fluid" style="border: 1px solid black;" alt="Choose the instance 'Region' and 'Zonal availability'." width="450"></p>
<ol start="10" type="1">
<li>Review the instance settings summary.</li>
</ol>
<p><img src="10_check_db_summary.png" class="img-fluid" style="border: 1px solid black;" alt="Review the instance summary." width="400"></p>
<ol start="11" type="1">
<li>Take a look at the <strong>“Pricing estimate”</strong>.</li>
</ol>
<p><img src="11_check_pricing_estimates.png" class="img-fluid" style="border: 1px solid black;" alt="Check the 'Pricing estimate'." width="400"></p>
<ol start="12" type="1">
<li>Click <strong>“CREATE INSTANCE”</strong>.</li>
</ol>
<p><img src="12_create_instance.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'CREATE INSTANCE'." width="200"></p>
<ol start="13" type="1">
<li>Wait for the instance creation to complete.</li>
</ol>
<p><img src="13_creating.png" class="img-fluid" style="border: 1px solid black;" alt="Wait for instance creation." width="450"></p>
<ol start="14" type="1">
<li>Once the green checkmark appears, your instance is ready.</li>
</ol>
<p><img src="14_created.png" class="img-fluid" style="border: 1px solid black;" alt="Wait for instance creation." width="450"></p>
<ol start="15" type="1">
<li>Now, let’s create our first database in the newly created instance. Click <strong>“Databases”</strong>.</li>
</ol>
<p><img src="15_create_database.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'Databases'." width="200"></p>
<ol start="16" type="1">
<li>Click <strong>“CREATE DATABASE”</strong>.</li>
</ol>
<p><img src="16_create_database.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'CREATE DATABASE'." width="400"></p>
<ol start="17" type="1">
<li>Set the <strong>“Database Name”</strong> and click <strong>“CREATE”</strong>.</li>
</ol>
<p><img src="17_set_db_name.png" class="img-fluid" style="border: 1px solid black;" alt="Fill in the 'Database Name' and click 'CREATE'." width="200"></p>
<ol start="18" type="1">
<li>Verify the new database is listed.</li>
</ol>
<p><img src="18_dbs_list.png" class="img-fluid" style="border: 1px solid black;" alt="Check the database creation." width="450"></p>
<ol start="19" type="1">
<li>Now, let’s create a new user for the database. Click <strong>“Users”</strong>.</li>
</ol>
<p><img src="19_create_user.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'Users'." width="200"></p>
<ol start="20" type="1">
<li>Click <strong>“ADD USER ACCOUNT”</strong>.</li>
</ol>
<p><img src="20_create_user.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'ADD USER ACCOUNT'." width="200"></p>
<ol start="21" type="1">
<li>Fill in the new <strong>“User name”</strong> and <strong>“Password”</strong>, and click <strong>“ADD”</strong>.</li>
</ol>
<p><img src="21_configure_new_user.png" class="img-fluid" style="border: 1px solid black;" alt="Fill the new user info and click 'ADD'." width="200"></p>
<ol start="22" type="1">
<li>Verify the new user was created.</li>
</ol>
<p><img src="22_users_list.png" class="img-fluid" style="border: 1px solid black;" alt="Check the user creation." width="450"></p>
<ol start="23" type="1">
<li>Now, let’s create our first table in the database. Click <strong>“Cloud SQL Studio”</strong>.</li>
</ol>
<p><img src="23_create_tables.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'Cloud SQL Studio'." width="200"></p>
<ol start="24" type="1">
<li>Login to the database using the <strong>“User”</strong> and <strong>“Password”</strong> you created in step 21.</li>
</ol>
<p><img src="24_login_with_user.png" class="img-fluid" style="border: 1px solid black;" alt="Login to the database." width="300"></p>
<ol start="25" type="1">
<li>Open an <strong>“Editor”</strong> tab.</li>
</ol>
<p><img src="25_select_sql_editor.png" class="img-fluid" style="border: 1px solid black;" alt="Click an 'Editor' tab." width="200"></p>
<ol start="26" type="1">
<li>Run SQL commands to create your desired tables.</li>
</ol>
<p><img src="26_run_your_sql_create_tables.png" class="img-fluid" style="border: 1px solid black;" alt="Run SQL code to create your tables." width="450"></p>
<ol start="27" type="1">
<li>Now, in order to be able to access the database from outside GCP, we will need to get the JSON keys for a GCP Service Account. In GCP’s <strong>“Search”</strong> panel, type <strong>“Service Accounts”</strong>, and click on that service. If you don’t have a service account to use, create a new one, by clicking on <strong>“CREATE SERVICE ACCOUNT”</strong>.</li>
</ol>
<p><img src="27_create_service_account.png" class="img-fluid" style="border: 1px solid black;" alt="Click to enter 'Service Accounts'." width="200"></p>
<ol start="28" type="1">
<li>Create the JSON keys for the service account. Click on the <strong>“Actions”</strong> (three dots).</li>
</ol>
<p><img src="28_create_sa_keys.png" class="img-fluid" style="border: 1px solid black;" alt="Click the three dots next to the service account." width="750"></p>
<ol start="29" type="1">
<li>Click <strong>“Manage keys”</strong>.</li>
</ol>
<p><img src="29_create_sa_keys.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'Manage keys'." width="200"></p>
<ol start="30" type="1">
<li>Click <strong>“ADD KEY”</strong> and then <strong>“Create new key”</strong>.</li>
</ol>
<p><img src="30_create_sa_keys.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'ADD KEY' and then 'Create new key'." width="200"></p>
<ol start="31" type="1">
<li>Check <strong>“JSON”</strong> and click <strong>“CREATE”</strong>. After creation, the JSON key will be downloaded by your browser, move this key file to <code>~/.gcp/</code>, e.g., <code>$ mv ~/Downloads/every-single-country-b2e753a1eee3.json ~/.gcp/everysinglecountry-sa-key.json</code>.</li>
</ol>
<p><img src="31_create_json_keys.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'CREATE'." width="450"></p>
<ol start="32" type="1">
<li>Now, to be able to access the database locally, we will use the <a href="https://cloud.google.com/sql/docs/postgres/connect-auth-proxy"><code>cloud-sql-proxy</code></a> command, for that we need to enable the <strong>“Cloud SQL Admin API”</strong>. In GCP’s <strong>“Search”</strong> panel, type <strong>“Cloud SQL Admin API”</strong>, and click on that service.</li>
</ol>
<p><img src="32_enable_sql_admin_api.png" class="img-fluid" style="border: 1px solid black;" alt="Click to enter 'Cloud SQL Admin API'." width="200"></p>
<ol start="33" type="1">
<li>Enable the <strong>“Cloud SQL Admin API”</strong> service by clicking <strong>“ENABLE”</strong>.</li>
</ol>
<p><img src="33_enable_sql_admin_api.png" class="img-fluid" style="border: 1px solid black;" alt="Click 'ENABLE'." width="400"></p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<ol type="1">
<li>List the available projects.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud projects list</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PROJECT_ID</span>              NAME                  PROJECT_NUMBER</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">every-single-country</span>    Every Single Country  122108936732</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Set the active project, in case it wasn’t already set.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud config set project every-single-country</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Updated</span> property <span class="pp">[</span><span class="ss">core/project</span><span class="pp">]</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Enable the Cloud SQL Admin API, to be able to use the <a href="https://cloud.google.com/sql/docs/postgres/connect-auth-proxy"><code>cloud-sql-proxy</code></a> command.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud services enable sqladmin.googleapis.com</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Operation</span> <span class="st">"operations/acat.p2-974569654945-b833df22-17ed-4724-8615-b9c271849917"</span> finished successfully.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>Create a Cloud SQL instance.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud sql instances create everysinglecountry <span class="dt">\</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--database-version</span><span class="op">=</span>POSTGRES_16 <span class="dt">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--tier</span><span class="op">=</span>db-custom-2-8192 <span class="dt">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span><span class="op">=</span>us-central1 <span class="dt">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--storage-size</span><span class="op">=</span>10GB <span class="dt">\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--edition</span><span class="op">=</span>ENTERPRISE <span class="dt">\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--backup</span> <span class="dt">\</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--enable-point-in-time-recovery</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Creating</span> Cloud SQL instance for POSTGRES_16...done.</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Created</span> <span class="pp">[</span><span class="ss">https://sqladmin.googleapis.com/sql/v1beta4/projects/every</span><span class="pp">-</span><span class="ss">single</span><span class="pp">-</span><span class="ss">country/instances/everysinglecountry</span><span class="pp">]</span>.</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ex">NAME</span>                DATABASE_VERSION  LOCATION       TIER              PRIMARY_ADDRESS  PRIVATE_ADDRESS  STATUS</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">everysinglecountry</span>  POSTGRES_16       us-central1-b  db-custom-2-8192  34.136.96.114    <span class="at">-</span>                RUNNABLE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li>Create a database in the instance.</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud sql databases create everysinglecountry <span class="at">--instance</span><span class="op">=</span>everysinglecountry</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Creating</span> Cloud SQL database...done.</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Created</span> database <span class="pp">[</span><span class="ss">everysinglecountry</span><span class="pp">]</span>.</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">instance:</span> everysinglecountry</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">name:</span> everysinglecountry</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">project:</span> every-single-country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="6" type="1">
<li>Create a new user for the database.</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud sql users create everysinglecountry <span class="dt">\</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--instance</span><span class="op">=</span>everysinglecountry <span class="dt">\</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--password</span><span class="op">=</span>YOUR_DB_PASSWORD</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Creating</span> Cloud SQL user...done.</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Created</span> user <span class="pp">[</span><span class="ss">everysinglecountry</span><span class="pp">]</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="7" type="1">
<li>Create a service account to be used by <code>cloud-sql-proxy</code>.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud iam service-accounts create everysinglecountry-sa <span class="dt">\</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--description</span><span class="op">=</span><span class="st">"EverySingleCountry Service Account"</span> <span class="dt">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--display-name</span><span class="op">=</span><span class="st">"everysinglecountry-sa"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Created</span> service account <span class="pp">[</span><span class="ss">everysinglecountry</span><span class="pp">-</span><span class="ss">sa</span><span class="pp">]</span>.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="8" type="1">
<li>Assign needed IAM Policy Bindings to the service account.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud projects add-iam-policy-binding every-single-country <span class="dt">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--member</span><span class="op">=</span><span class="st">"serviceAccount:everysinglecountry-sa@every-single-country.iam.gserviceaccount.com"</span> <span class="dt">\</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--role</span><span class="op">=</span><span class="st">"roles/cloudsql.client"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Updated</span> IAM policy for project <span class="pp">[</span><span class="ss">every</span><span class="pp">-</span><span class="ss">single</span><span class="pp">-</span><span class="ss">country</span><span class="pp">]</span>.</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">bindings:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span> members:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> serviceAccount:everysinglecountry-sa@every-single-country.iam.gserviceaccount.com</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">role:</span> roles/cloudsql.client</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span> members:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> serviceAccount:firebase-service-account@firebase-sa-management.iam.gserviceaccount.com</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> serviceAccount:service-974569654945@gcp-sa-firebase.iam.gserviceaccount.com</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">role:</span> roles/firebase.managementServiceAgent</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span> members:</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> serviceAccount:firebase-adminsdk-efpkq@every-single-country.iam.gserviceaccount.com</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">role:</span> roles/firebase.sdkAdminServiceAgent</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span> members:</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> serviceAccount:firebase-adminsdk-efpkq@every-single-country.iam.gserviceaccount.com</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">role:</span> roles/iam.serviceAccountTokenCreator</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span> members:</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> user:everysinglecountryproject@gmail.com</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">role:</span> roles/owner</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="ex">etag:</span> BwYo24Y3_jQ=</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="ex">version:</span> 1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="9" type="1">
<li>Generate a JSON key for the service account .</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud iam service-accounts keys create ~/.gcp/everysinglecountry-sa-key.json <span class="at">--iam-account</span><span class="op">=</span>everysinglecountry-sa@every-single-country.iam.gserviceaccount.com</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">created</span> key <span class="pp">[</span><span class="ss">6b71b4f4895ead65646249bf76c05093467669bf</span><span class="pp">]</span> of type <span class="pp">[</span><span class="ss">json</span><span class="pp">]</span> as <span class="pp">[</span><span class="ss">/Users/jcrodriguez/.gcp/everysinglecountry</span><span class="pp">-</span><span class="ss">sa</span><span class="pp">-</span><span class="ss">key.json</span><span class="pp">]</span> for <span class="pp">[</span><span class="ss">everysinglecountry</span><span class="pp">-</span><span class="ss">sa@every</span><span class="pp">-</span><span class="ss">single</span><span class="pp">-</span><span class="ss">country.iam.gserviceaccount.com</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="connect-locally-to-the-database" class="level2">
<h2 class="anchored" data-anchor-id="connect-locally-to-the-database">Connect Locally to the Database</h2>
<p>The Cloud SQL database we just created is not publicly accessible and can only be reached within the GCP environment. To connect to your database locally, follow these steps:</p>
<ol type="1">
<li>Get the instance’s connection name.</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the connection name of the Cloud SQL instance.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud sql instances describe everysinglecountry <span class="at">--format</span><span class="op">=</span><span class="st">"get(connectionName)"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">every-single-country:us-central1:everysinglecountry</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li>Setup a tunnel to access locally the database, using a Cloud SQL Proxy.</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Cloud SQL Proxy to create a secure connection to the database.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cloud-sql-proxy every-single-country:us-central1:everysinglecountry <span class="at">--credentials-file</span><span class="op">=</span>/Users/jcrodriguez/.gcp/everysinglecountry-sa-key.json </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2024/12/26</span> 16:49:19 Authorizing with the credentials file at <span class="st">"/Users/jcrodriguez/.gcp/everysinglecountry-sa-key.json"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2024/12/26</span> 16:49:21 <span class="pp">[</span><span class="ss">every</span><span class="pp">-</span><span class="ss">single</span><span class="pp">-</span><span class="ss">country:us</span><span class="pp">-</span><span class="ss">central1:everysinglecountry</span><span class="pp">]</span> Listening on 127.0.0.1:5432</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">2024/12/26</span> 16:49:21 The proxy has started successfully and is ready for new connections!</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>At this point, the Cloud SQL Proxy is listening on localhost:5432, and you’re ready to connect to your database.</p>
<ol start="3" type="1">
<li>Connect to the database in R.</li>
</ol>
<p>Now that the proxy is set up, you can connect to your database locally from R using the <code>{DBI}</code> package and the appropriate PostgreSQL driver. Here’s an example connection:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cn <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">drv =</span> RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname =</span> <span class="st">"everysinglecountry"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">"localhost"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">user =</span> <span class="st">"everysinglecountry"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="st">"YOUR_DB_PASSWORD"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">port =</span> <span class="dv">5432</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbListTables</span>(cn)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>DBI<span class="sc">::</span><span class="fu">dbDisconnect</span>(cn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="enable-cloud-sql-access-for-your-shiny-app" class="level2">
<h2 class="anchored" data-anchor-id="enable-cloud-sql-access-for-your-shiny-app">Enable Cloud SQL Access for your Shiny App</h2>
<p>If you have deployed your Shiny app on a GCP Cloud Run service, as demonstrated in our blog post <a href="../deploy-your-shiny-app">Deploy Your Shiny App on Google Cloud Platform</a>, you need to grant it access to your Cloud SQL database. To do this, add the <code>--add-cloudsql-instances</code> flag to your deployment script:</p>
<p><code>--add-cloudsql-instances=every-single-country:us-central1:everysinglecountry</code></p>
<p>The updated deployment command should look like this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gcloud run deploy everysinglecountry <span class="dt">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--image</span> gcr.io/every-single-country/everysinglecountry:latest <span class="dt">\</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--platform</span> managed <span class="dt">\</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span> us-central1 <span class="dt">\</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--allow-unauthenticated</span> <span class="dt">\</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--add-cloudsql-instances</span><span class="op">=</span>every-single-country:us-central1:everysinglecountry</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This configuration allows your app to connect “locally” to the database via the Cloud SQL instance. For details on connecting to the database locally, refer to the previous section.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Enabling and configuring a Cloud SQL database in Google Cloud Platform is a straightforward process that provides a robust and secure environment for your data. By following this guide, you’ve set up a PostgreSQL instance, created a database, added users, and connected to it locally using the Cloud SQL Proxy. These steps ensure that your database is accessible only through secure methods, enhancing both performance and security.</p>
<p>As you deploy your applications, such as Shiny apps, you can seamlessly integrate them with your Cloud SQL database to manage and analyze data efficiently. GCP’s powerful tools and scalability options make it an ideal platform for hosting and managing your databases.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/RtoProd\.com\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="RtoProd/RtoProd.github.io" data-repo-id="R_kgDONHF92g" data-category="General" data-category-id="" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->




</body></html>